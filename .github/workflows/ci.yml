name: CI

on:
  pull_request:
    branches: [ Dev, main ]
    paths:
      - "web/**"
      - ".github/workflows/**"
  push:
    branches: [ Dev ]
    paths:
      - "web/**"
      - ".github/workflows/**"

jobs:
  setup:
    name: Setup (cache deps)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    outputs:
      node-cache-hit: ${{ steps.cache-npm.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web/package-lock.json
      - name: Cache node_modules
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            web/node_modules
          key: ${{ runner.os }}-node20-${{ hashFiles('web/package-lock.json') }}
      - name: Install deps
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

  # lint:
  #   name: Lint
  #   needs: setup
  #   runs-on: ubuntu-latest
  #   defaults: { run: { working-directory: web } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with: { node-version: 20, cache: npm, cache-dependency-path: web/package-lock.json }
  #     - run: npm ci
  #     - run: npm run lint

  typecheck:
    name: TypeScript
    needs: setup
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: web } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm, cache-dependency-path: web/package-lock.json }
      - run: npm ci
      - run: npm run typecheck

  unit:
    name: Unit tests
    needs: [setup, typecheck]
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: web } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm, cache-dependency-path: web/package-lock.json }
      - run: npm ci
      - run: npm run test:cov
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: web/coverage

  build:
    name: Build (PR artifact)
    needs: [unit]
    runs-on: ubuntu-latest
    env:
      VITE_BASE_PATH: /web   # adjust if your GH Pages path differs
    defaults: { run: { working-directory: web } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm, cache-dependency-path: web/package-lock.json }
      - run: npm ci
      - run: npm run build
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist
